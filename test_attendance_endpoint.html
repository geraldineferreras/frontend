<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Attendance Endpoint</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { border-color: #28a745; background-color: #d4edda; }
        .error { border-color: #dc3545; background-color: #f8d7da; }
        .info { border-color: #17a2b8; background-color: #d1ecf1; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .loading {
            color: #007bff;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>Test Attendance Endpoint</h1>
    
    <div class="container">
        <h2>Student Attendance API Test</h2>
        <p>This test will verify that the attendance endpoint is working correctly and returning the expected data structure.</p>
        
        <div class="test-section info">
            <h3>Endpoint Information</h3>
            <p><strong>URL:</strong> <code>http://localhost/scms_new_backup/index.php/api/attendance/student</code></p>
            <p><strong>Method:</strong> GET</p>
            <p><strong>Expected Response:</strong> JSON with attendance records</p>
        </div>

        <div class="test-section">
            <h3>Test 1: Basic Endpoint Call</h3>
            <button onclick="testBasicEndpoint()" id="btn1">Test Basic Endpoint</button>
            <div id="result1" class="result"></div>
        </div>

        <div class="test-section">
            <h3>Test 2: Endpoint with Date Filters</h3>
            <button onclick="testEndpointWithFilters()" id="btn2">Test with Date Filters</button>
            <div id="result2" class="result"></div>
        </div>

        <div class="test-section">
            <h3>Test 3: Simulate Dashboard Data Processing</h3>
            <button onclick="testDashboardProcessing()" id="btn3">Test Dashboard Processing</button>
            <div id="result3" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost/scms_new_backup/index.php/api';
        
        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = content;
            element.className = `result ${type}`;
        }

        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = '<span class="loading">Loading...</span>';
            element.className = 'result info';
        }

        async function testBasicEndpoint() {
            const btn = document.getElementById('btn1');
            const resultId = 'result1';
            
            btn.disabled = true;
            showLoading(resultId);
            
            try {
                const response = await fetch(`${API_BASE}/attendance/student`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult(resultId, 
                        `✅ SUCCESS: Endpoint is accessible\n\n` +
                        `Status: ${response.status}\n` +
                        `Response Structure:\n${JSON.stringify(data, null, 2)}`, 
                        'success'
                    );
                } else {
                    showResult(resultId, 
                        `❌ ERROR: Endpoint returned error\n\n` +
                        `Status: ${response.status}\n` +
                        `Error: ${JSON.stringify(data, null, 2)}`, 
                        'error'
                    );
                }
            } catch (error) {
                showResult(resultId, 
                    `❌ ERROR: Failed to connect to endpoint\n\n` +
                    `Error: ${error.message}\n\n` +
                    `Make sure:\n` +
                    `1. Your local server is running\n` +
                    `2. The endpoint URL is correct\n` +
                    `3. CORS is properly configured`, 
                    'error'
                );
            } finally {
                btn.disabled = false;
            }
        }

        async function testEndpointWithFilters() {
            const btn = document.getElementById('btn2');
            const resultId = 'result2';
            
            btn.disabled = true;
            showLoading(resultId);
            
            try {
                // Test with date filters (last 30 days)
                const today = new Date();
                const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                
                const params = new URLSearchParams({
                    date_from: thirtyDaysAgo.toISOString().split('T')[0],
                    date_to: today.toISOString().split('T')[0]
                });
                
                const response = await fetch(`${API_BASE}/attendance/student?${params}`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult(resultId, 
                        `✅ SUCCESS: Endpoint with filters is working\n\n` +
                        `Status: ${response.status}\n` +
                        `Date Range: ${thirtyDaysAgo.toISOString().split('T')[0]} to ${today.toISOString().split('T')[0]}\n` +
                        `Response Structure:\n${JSON.stringify(data, null, 2)}`, 
                        'success'
                    );
                } else {
                    showResult(resultId, 
                        `❌ ERROR: Endpoint with filters returned error\n\n` +
                        `Status: ${response.status}\n` +
                        `Error: ${JSON.stringify(data, null, 2)}`, 
                        'error'
                    );
                }
            } catch (error) {
                showResult(resultId, 
                    `❌ ERROR: Failed to test endpoint with filters\n\n` +
                    `Error: ${error.message}`, 
                    'error'
                );
            } finally {
                btn.disabled = false;
            }
        }

        async function testDashboardProcessing() {
            const btn = document.getElementById('btn3');
            const resultId = 'result3';
            
            btn.disabled = true;
            showLoading(resultId);
            
            try {
                // Simulate the dashboard data processing
                const today = new Date();
                const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                
                const params = new URLSearchParams({
                    date_from: thirtyDaysAgo.toISOString().split('T')[0],
                    date_to: today.toISOString().split('T')[0]
                });
                
                const response = await fetch(`${API_BASE}/attendance/student?${params}`);
                const data = await response.json();
                
                if (response.ok && data.data && data.data.records) {
                    const records = data.data.records;
                    
                    // Process attendance data like the dashboard does
                    const presentCount = records.filter(r => 
                        (r.status || r.attendance_status || r.present || r.is_present)?.toString().toLowerCase() === 'present' ||
                        (r.status || r.attendance_status || r.present || r.is_present)?.toString().toLowerCase() === '1' ||
                        (r.status || r.attendance_status || r.present || r.is_present)?.toString().toLowerCase() === 'true'
                    ).length;
                    
                    const absentCount = records.filter(r => 
                        (r.status || r.attendance_status || r.present || r.is_present)?.toString().toLowerCase() === 'absent' ||
                        (r.status || r.attendance_status || r.present || r.is_present)?.toString().toLowerCase() === '0' ||
                        (r.status || r.attendance_status || r.present || r.is_present)?.toString().toLowerCase() === 'false'
                    ).length;
                    
                    const lateCount = records.filter(r => 
                        (r.status || r.attendance_status || r.present || r.is_present)?.toString().toLowerCase() === 'late'
                    ).length;
                    
                    showResult(resultId, 
                        `✅ SUCCESS: Dashboard processing simulation\n\n` +
                        `Total Records: ${records.length}\n` +
                        `Present Count: ${presentCount}\n` +
                        `Absent Count: ${absentCount}\n` +
                        `Late Count: ${lateCount}\n\n` +
                        `Dashboard will display: ${presentCount} (not percentage)\n\n` +
                        `Sample Records:\n${JSON.stringify(records.slice(0, 3), null, 2)}`, 
                        'success'
                    );
                } else {
                    showResult(resultId, 
                        `❌ ERROR: Cannot process dashboard data\n\n` +
                        `Response: ${JSON.stringify(data, null, 2)}`, 
                        'error'
                    );
                }
            } catch (error) {
                showResult(resultId, 
                    `❌ ERROR: Failed to simulate dashboard processing\n\n` +
                    `Error: ${error.message}`, 
                    'error'
                );
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
