<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Login System Test - SCMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }
        .endpoint-info {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
        .response-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-top: 1rem;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .test-email {
            font-weight: bold;
            color: #0d6efd;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">üîê Unified Login System Test</h1>
        
        <div class="alert alert-info">
            <strong>What This Tests:</strong> The unified account system that automatically detects account types and shows appropriate login options.
        </div>

        <!-- Account Status Testing -->
        <div class="test-section">
            <h3>1. Check Account Status</h3>
            <p>Test different email addresses to see what login options are available:</p>
            
            <div class="endpoint-info">
                <strong>Endpoint:</strong> <code>POST /api/auth/account-status</code><br>
                <strong>Purpose:</strong> Check what login options a user has before showing the login form
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Test Email Addresses:</label>
                        <select class="form-select" id="testEmailSelect">
                            <option value="local@example.com">local@example.com (Password only)</option>
                            <option value="google@example.com">google@example.com (Google only)</option>
                            <option value="unified@example.com">unified@example.com (Both methods)</option>
                            <option value="new@example.com">new@example.com (Default: Unified)</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="checkAccountStatus()">Check Account Status</button>
                </div>
                <div class="col-md-6">
                    <div class="response-display" id="accountStatusResponse">
                        Response will appear here...
                    </div>
                </div>
            </div>
        </div>

        <!-- Google OAuth Testing -->
        <div class="test-section">
            <h3>2. Google OAuth Authentication</h3>
            <p>Test the Google OAuth flow with the unified system:</p>
            
            <div class="endpoint-info">
                <strong>Endpoint:</strong> <code>POST /api/auth/google</code><br>
                <strong>Purpose:</strong> Handle Google authentication and automatically create/link accounts
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Google User ID:</label>
                        <input type="text" class="form-control" id="googleId" value="google_123456789" placeholder="Google user ID">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email:</label>
                        <input type="email" class="form-control" id="googleEmail" value="test@example.com" placeholder="Email address">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Full Name:</label>
                        <input type="text" class="form-control" id="googleName" value="Test User" placeholder="Full name">
                    </div>
                    <button class="btn btn-success" onclick="testGoogleAuth()">Test Google OAuth</button>
                </div>
                <div class="col-md-6">
                    <div class="response-display" id="googleAuthResponse">
                        Response will appear here...
                    </div>
                </div>
            </div>
        </div>

        <!-- Account Linking Testing -->
        <div class="test-section">
            <h3>3. Account Linking/Unlinking</h3>
            <p>Test linking and unlinking Google accounts:</p>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="endpoint-info">
                        <strong>Link Google Account:</strong> <code>POST /api/auth/link-google</code><br>
                        <strong>Unlink Google Account:</strong> <code>POST /api/auth/unlink-google</code>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Email:</label>
                        <input type="email" class="form-control" id="linkEmail" value="user@example.com" placeholder="Email address">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Google ID:</label>
                        <input type="text" class="form-control" id="linkGoogleId" value="google_987654321" placeholder="Google user ID">
                    </div>
                    
                    <div class="btn-group" role="group">
                        <button class="btn btn-primary" onclick="testLinkGoogle()">Link Google Account</button>
                        <button class="btn btn-outline-danger" onclick="testUnlinkGoogle()">Unlink Google Account</button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="response-display" id="linkResponse">
                        Response will appear here...
                    </div>
                </div>
            </div>
        </div>

        <!-- Frontend Implementation Demo -->
        <div class="test-section">
            <h3>4. Frontend Implementation Demo</h3>
            <p>This shows how the frontend would dynamically adjust based on account status:</p>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Enter Email to See UI Changes:</label>
                        <input type="email" class="form-control" id="demoEmail" placeholder="Enter email to see login options" onchange="updateDemoUI()">
                    </div>
                    
                    <div id="demoLoginForm" class="border rounded p-3">
                        <h5>Login Form</h5>
                        <div id="demoFormContent">
                            <p class="text-muted">Enter an email above to see available login options...</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="endpoint-info">
                        <strong>Frontend Logic:</strong><br>
                        ‚Ä¢ <span class="test-email">local@example.com</span> ‚Üí Password field only<br>
                        ‚Ä¢ <span class="test-email">google@example.com</span> ‚Üí Google button only<br>
                        ‚Ä¢ <span class="test-email">unified@example.com</span> ‚Üí Both password + Google<br>
                        ‚Ä¢ <span class="test-email">new@example.com</span> ‚Üí Default to unified
                    </div>
                    
                    <div class="response-display" id="demoResponse">
                        Account status will appear here...
                    </div>
                </div>
            </div>
        </div>

        <!-- API Documentation -->
        <div class="test-section">
            <h3>5. API Endpoints Summary</h3>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Endpoint</th>
                            <th>Method</th>
                            <th>Purpose</th>
                            <th>Auth Required</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>/api/auth/account-status</code></td>
                            <td>POST</td>
                            <td>Check available login methods</td>
                            <td>No</td>
                        </tr>
                        <tr>
                            <td><code>/api/auth/google</code></td>
                            <td>POST</td>
                            <td>Google OAuth authentication</td>
                            <td>No</td>
                        </tr>
                        <tr>
                            <td><code>/api/auth/link-google</code></td>
                            <td>POST</td>
                            <td>Link Google to local account</td>
                            <td>Yes</td>
                        </tr>
                        <tr>
                            <td><code>/api/auth/unlink-google</code></td>
                            <td>POST</td>
                            <td>Unlink Google from account</td>
                            <td>Yes</td>
                        </tr>
                        <tr>
                            <td><code>/api/auth/login</code></td>
                            <td>POST</td>
                            <td>Local password login</td>
                            <td>No</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost/scms_new_backup/index.php/api';

        // Test Account Status
        async function checkAccountStatus() {
            const email = document.getElementById('testEmailSelect').value;
            const responseDiv = document.getElementById('accountStatusResponse');
            
            responseDiv.textContent = 'Checking account status...';
            
            try {
                const response = await fetch(`${API_BASE}/auth/account-status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                
                const data = await response.json();
                responseDiv.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                responseDiv.textContent = `Error: ${error.message}`;
            }
        }

        // Test Google OAuth
        async function testGoogleAuth() {
            const googleId = document.getElementById('googleId').value;
            const email = document.getElementById('googleEmail').value;
            const fullName = document.getElementById('googleName').value;
            const responseDiv = document.getElementById('googleAuthResponse');
            
            responseDiv.textContent = 'Testing Google OAuth...';
            
            try {
                const response = await fetch(`${API_BASE}/auth/google`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        google_id: googleId,
                        email: email,
                        full_name: fullName
                    })
                });
                
                const data = await response.json();
                responseDiv.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                responseDiv.textContent = `Error: ${error.message}`;
            }
        }

        // Test Link Google Account
        async function testLinkGoogle() {
            const email = document.getElementById('linkEmail').value;
            const googleId = document.getElementById('linkGoogleId').value;
            const responseDiv = document.getElementById('linkResponse');
            
            responseDiv.textContent = 'Linking Google account...';
            
            try {
                const response = await fetch(`${API_BASE}/auth/link-google`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        google_id: googleId
                    })
                });
                
                const data = await response.json();
                responseDiv.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                responseDiv.textContent = `Error: ${error.message}`;
            }
        }

        // Test Unlink Google Account
        async function testUnlinkGoogle() {
            const email = document.getElementById('linkEmail').value;
            const responseDiv = document.getElementById('linkResponse');
            
            responseDiv.textContent = 'Unlinking Google account...';
            
            try {
                const response = await fetch(`${API_BASE}/auth/unlink-google`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });
                
                const data = await response.json();
                responseDiv.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                responseDiv.textContent = `Error: ${error.message}`;
            }
        }

        // Update Demo UI based on email
        async function updateDemoUI() {
            const email = document.getElementById('demoEmail').value;
            const formContent = document.getElementById('demoFormContent');
            const demoResponse = document.getElementById('demoResponse');
            
            if (!email || !email.includes('@')) {
                formContent.innerHTML = '<p class="text-muted">Enter an email above to see available login options...</p>';
                demoResponse.textContent = 'Account status will appear here...';
                return;
            }
            
            // Check account status
            try {
                const response = await fetch(`${API_BASE}/auth/account-status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                
                const data = await response.json();
                demoResponse.textContent = JSON.stringify(data, null, 2);
                
                // Update form UI based on account type
                let formHTML = '<h5>Login Form</h5>';
                
                if (data.success) {
                    const accountType = data.data.account_type;
                    
                    switch (accountType) {
                        case 'local':
                            formHTML += `
                                <div class="mb-3">
                                    <label class="form-label">Password</label>
                                    <input type="password" class="form-control" placeholder="Enter your password">
                                </div>
                                <button class="btn btn-primary w-100">Sign in with Password</button>
                                <div class="mt-2">
                                    <small class="text-muted">This account uses password authentication only.</small>
                                </div>
                            `;
                            break;
                        case 'google':
                            formHTML += `
                                <button class="btn btn-outline-dark w-100">
                                    <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" width="18" height="18" class="me-2">
                                    Sign in with Google
                                </button>
                                <div class="mt-2">
                                    <small class="text-muted">This account uses Google authentication only.</small>
                                </div>
                            `;
                            break;
                        case 'unified':
                            formHTML += `
                                <div class="mb-3">
                                    <label class="form-label">Password</label>
                                    <input type="password" class="form-control" placeholder="Enter your password">
                                </div>
                                <button class="btn btn-primary w-100 mb-3">Sign in with Password</button>
                                <div class="text-center mb-2">
                                    <small class="text-muted">Or</small>
                                </div>
                                <button class="btn btn-outline-dark w-100">
                                    <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" width="18" height="18" class="me-2">
                                    Sign in with Google
                                </button>
                                <div class="mt-2">
                                    <small class="text-muted">This account supports both password and Google authentication.</small>
                                </div>
                            `;
                            break;
                        default:
                            formHTML += '<p class="text-muted">Unknown account type</p>';
                    }
                } else {
                    formHTML += '<p class="text-danger">Failed to check account status</p>';
                }
                
                formContent.innerHTML = formHTML;
                
            } catch (error) {
                demoResponse.textContent = `Error: ${error.message}`;
                formContent.innerHTML = '<p class="text-danger">Error checking account status</p>';
            }
        }

        // Initialize demo
        document.addEventListener('DOMContentLoaded', function() {
            // Set default test email
            document.getElementById('demoEmail').value = 'unified@example.com';
            updateDemoUI();
        });
    </script>
</body>
</html>
